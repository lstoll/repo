#!/bin/bash
set -euo pipefail

. /etc/lsb-release

# TODO - why do we have to do this.
function finish {
    if [ -f ~/.netrc.tmp ]; then
        mv ~/.netrc.tmp ~/.netrc
    fi
}
trap finish EXIT
if [ -f ~/.netrc ]; then
    echo "--> Temporarily relocating netrc"
    mv ~/.netrc ~/.netrc.tmp
fi

if [ ! -f /usr/bin/ansible-playbook ]; then
    if [ "$DISTRIB_CODENAME" == "xenial" ]; then
        sudo apt-get install -y software-properties-common
        sudo apt-add-repository -y ppa:ansible/ansible
    fi
    sudo apt-get update || true 
    sudo apt-get install -y ansible
fi

sudo ansible-playbook -i "localhost," -c local playbook.yml

rm -f playbook.retry
